{% load static %}
{% load django_bootstrap5 %}
<html>

<head class="fixed-top">
    <meta charset="UTF-8">
    <title>トゥットゥルー♪</title>
    <link rel="icon" href="{% static 'media/icon_white.ico' %}" type="image/x-icon">
    {% bootstrap_css %}
    {% bootstrap_javascript %}
    <script src="https://kit.fontawesome.com/e49b9fdb64.js" crossorigin="anonymous"></script>
    {% block extraheader %}{% endblock %}
</head>

<body>
    <nav class="navbar navbar-expand flex-md-row navbar-dark bg-dark">
        <div class="container justify-content-between">
            <a href="/" class="navbar-brand"><img src="{% static 'media/icon.svg' %}" height="30px">トゥットゥルー♪</a>
            <ul class="navbar-nav mr-md-2">
                {% if user.is_authenticated %}
                <form id="logout-form" method="post" action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="nav-link btn btn-link" style="padding: 0;">
                        {{ user.username }}さん　ログアウト</button>
                </form>
                {% else %}
                <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">ログイン</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'signup' %}">会員登録</a></li>
                {% endif %}
            </ul>
        </div>
    </nav>
    <main>
        <div class="container">
            {% block main %}{% endblock %}
        </div>
    </main>
    <footer class="fixed-bottom">
        <!-- {% block footer %}{% endblock %} -->
        <div class="text-end pe-3 pb-5 fs-1">
            {% if user.is_authenticated %}
            <button class="btn btn-primary text-light fs-3" data-bs-toggle="modal" data-bs-target="#tootModal"><i
                    class="fa-solid fa-plus fs-1"></i></button>
            {% else %}
            <a class="btn btn-primary text-light" href="{% url 'login' %}"><i class="fa-solid fa-plus"></i></a>
            {% endif %}
        </div>
        <div class="bottom-navbar bg-dark py-2">
            <div class="container">
                <ul class="nav justify-content-around">
                    <li class="nav-item">
                        <a class="nav-link text-light fs-3" href="{% url 'root' %}" style="z-index: 100;">
                            <i class="fa-solid fa-house fs-1"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        {% if user.is_authenticated %}
                        <a class="nav-link text-light fs-3" href="{% url 'user_detail' user.id %}">
                            <i class="fa-solid fa-user fs-1"></i>
                        </a>
                        {% else %}
                        <a class="nav-link text-light fs-3" href="">
                            <i class="fa-solid fa-user fs-1"></i>
                        </a>
                        {% endif %}
                    </li>
                    <li class="nav-item">
                        {% if user.is_authenticated %}
                        <a class="nav-link text-light fs-3" href="{% url 'user_edit' user.id %}">
                            <i class="fa-solid fa-pen fs-1"></i>
                        </a>
                        {% else %}
                        <a class="nav-link text-light fs-3" href="">
                            <i class="fa-solid fa-user fs-1"></i>
                        </a>
                        {% endif %}
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-light fs-3" href="#">
                            <i class="fa-solid fa-magnifying-glass fs-1"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </footer>


    <!-- モーダルの追加 -->
    <div class="modal" id="tootModal" tabindex="-1" aria-labelledby="tootModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tootModalLabel">toot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="{% url 'toot_new' %}">
                        {% csrf_token %}
                        {% if form %}
                        {% bootstrap_form form %}
                        {% endif %}
                        <div class="text-end">{% bootstrap_button button_type='submit' content='トゥトゥる' %}</div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- base.html の最後に追加 -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.follow-btn').forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault();
                const form = this.closest('form');
                const url = form.getAttribute('action');
                const formData = new FormData(form);

                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',  // Django の Ajax CSRF 対策用
                        'X-CSRFToken': '{{ csrf_token }}'     // CSRF トークンのセット
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const followersCountElement = document.getElementById('followers-count');
                    const followingCountElement = document.getElementById('following-count');

                    if (form.id === 'follow-form') {
                        button.textContent = 'フォロー解除';
                        button.classList.remove('btn-primary');
                        button.classList.add('btn-secondary');
                        form.setAttribute('action', url.replace('follow', 'unfollow'));
                        followersCountElement.textContent = data.followers_count;
                        followingCountElement.textContent = data.following_count;
                    } else if (form.id === 'unfollow-form') {
                        button.textContent = 'フォローする';
                        button.classList.remove('btn-secondary');
                        button.classList.add('btn-primary');
                        form.setAttribute('action', url.replace('unfollow', 'follow'));
                        followersCountElement.textContent = data.followers_count;
                        followingCountElement.textContent = data.following_count;
                    }
                })
                .catch(error => {
                    console.error('フォロー操作に失敗しました。', error);
                    alert('フォロー操作に失敗しました。');
                });
            });
        });
    });
</script>



</html>